{
  "version": 3,
  "sources": ["/Users/stojg/Sites/canola/src/lib/light.ts"],
  "sourcesContent": ["import { glMatrix, mat4, vec3, vec4 } from 'gl-matrix'\nimport type REGL from 'regl'\nimport deepmerge from 'deepmerge'\nimport { xyz } from './swizzle'\n\n// shadowFBOs: REGL.FramebufferCube[] = []\n// this.shadowFBOs[id] = regl.framebufferCube({\n//   radius: CUBE_MAP_SIZE,\n//   colorType: 'half float',\n// })\n\nconst POINT_LIGHT_CUBE_MAP_SIZE = 512\nconst BLACK = vec3.fromValues(0, 0, 0)\n\nexport class Lights {\n  lights: Light[] = []\n\n  push(l: Light) {\n    this.lights.push(l)\n  }\n\n  config(): REGL.DrawConfig {\n    const a: Record<string, any> = {}\n    this.lights.forEach((l: Light, idx: number) => {\n      a[`lights[${idx}].intensity`] = l.intensity\n      a[`lights[${idx}].position`] = l.position\n      a[`lights[${idx}].color`] = l.color\n    })\n    console.log(a)\n    return {\n      uniforms: a,\n    }\n  }\n\n  forEach(callbackfn: (value: Light, index: number, array: Light[]) => void, thisArg?: any): void {\n    this.lights.forEach(callbackfn, thisArg)\n  }\n\n  get(number: number): Light {\n    return this.lights[number]\n  }\n}\n\nexport class Light {\n  protected _shadowFBO: REGL.Resource\n  protected _regl: REGL.Regl\n  protected _intensity: number\n  protected _color: vec3\n  protected _position: vec4\n\n  constructor(regl: REGL.Regl, intensity: number, clr: vec3, pos: vec4, fbo?: REGL.Resource) {\n    this._regl = regl\n    this._intensity = intensity\n    this._color = clr\n    this._position = pos\n    this._shadowFBO = fbo || regl.framebuffer({})\n  }\n\n  get on(): boolean {\n    return this._intensity > 0.001\n  }\n\n  get intensity(): number {\n    return this._intensity\n  }\n\n  get position(): vec4 {\n    return this._position\n  }\n\n  get color(): vec3 {\n    return this._color\n  }\n\n  uniform(): REGL.DrawConfig {\n    return {\n      uniforms: {\n        'light.color': this.color,\n        'light.position': this.position,\n        'light.intensity': this.intensity,\n      },\n    }\n  }\n\n  depthDrawConfig(previous: {} = {}) {\n    return previous\n  }\n\n  shadowFBO(): REGL.Resource {\n    return this._shadowFBO\n  }\n}\n\nexport class DirectionalLight extends Light {\n  constructor(regl: REGL.Regl, intensity: number, clr: vec3, pos: vec3) {\n    super(regl, intensity, clr, [pos[0], pos[1], pos[2], 1])\n  }\n}\n\nexport class PointLight extends Light {\n  _shadowFBO: REGL.FramebufferCube\n  constructor(regl: REGL.Regl, intensity: number, clr: vec3, pos: vec3) {\n    super(regl, intensity, clr, [pos[0], pos[1], pos[2], 0])\n    this._shadowFBO = regl.framebufferCube({\n      radius: POINT_LIGHT_CUBE_MAP_SIZE,\n      colorType: 'half float',\n    })\n  }\n\n  depthDrawConfig(previous: {} = {}) {\n    const shadowFbo = this._shadowFBO\n    const proj = mat4.perspective(mat4.create(), glMatrix.toRadian(90), 1, 0.5, 15.0)\n    return deepmerge(previous, {\n      uniforms: {\n        'light.color': this.color,\n        'light.position': this.position,\n        'light.intensity': this.intensity,\n        projectionView: (context: REGL.DefaultContext, props: any, batchId: number) => {\n          switch (batchId) {\n            case 0: // +x right\n              return mat4.mul(mat4.create(), proj, mat4.lookAt(mat4.create(), xyz(this.position), vec3.add(vec3.create(), vec3.fromValues(1, 0, 0), xyz(this.position)), [0, -1, 0]))\n            case 1: // -x left\n              return mat4.mul(mat4.create(), proj, mat4.lookAt(mat4.create(), xyz(this.position), vec3.add(vec3.create(), vec3.fromValues(-1, 0, 0), xyz(this.position)), [0, -1, 0]))\n            case 2: // +y top\n              return mat4.mul(mat4.create(), proj, mat4.lookAt(mat4.create(), xyz(this.position), vec3.add(vec3.create(), vec3.fromValues(0, 1, 0), xyz(this.position)), [0, 0, 1]))\n            case 3: // -y bottom\n              return mat4.mul(mat4.create(), proj, mat4.lookAt(mat4.create(), xyz(this.position), vec3.add(vec3.create(), vec3.fromValues(0, -1, 0), xyz(this.position)), [0, 0, -1]))\n            case 4: // +z near\n              return mat4.mul(mat4.create(), proj, mat4.lookAt(mat4.create(), xyz(this.position), vec3.add(vec3.create(), vec3.fromValues(0, 0, 1), xyz(this.position)), [0, -1, 0]))\n            case 5: // -z far\n              return mat4.mul(mat4.create(), proj, mat4.lookAt(mat4.create(), xyz(this.position), vec3.add(vec3.create(), vec3.fromValues(0, 0, -1), xyz(this.position)), [0, -1, 0]))\n          }\n        },\n      },\n      framebuffer: function (context: REGL.DefaultContext, props: {}, batchId: number) {\n        return shadowFbo.faces[batchId]\n      },\n    })\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
