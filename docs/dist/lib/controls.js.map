{
  "version": 3,
  "sources": ["/Users/stojg/Sites/canola/src/lib/controls.ts"],
  "sourcesContent": ["import mouseChange from 'mouse-change'\nimport { vec2 } from 'gl-matrix'\n\nclass Controls {}\n\nexport interface MetaButtons {\n  shift: boolean\n  alt: boolean\n  control: boolean\n  meta: boolean\n}\n\nexport class FPSControls extends Controls {\n  private static keysDown: Record<string, boolean> = {}\n  private _pointerLocked: boolean = false\n  private _canvas: HTMLCanvasElement\n  private _mouseMovementX: number = 0\n  private _mouseMovementY: number = 0\n\n  constructor(canvas: HTMLCanvasElement) {\n    super()\n    window.addEventListener('keydown', this.onKeyDown, false)\n    window.addEventListener('keyup', this.onKeyUp, false)\n    this._canvas = canvas\n    this.initPointerLock()\n    mouseChange((buttons: any, x: number, y: number, mods: MetaButtons) => {\n      if (this.pointerLocked && buttons & 2) {\n        this.exitPointerlock()\n      }\n    })\n  }\n\n  onKeyDown(ev: KeyboardEvent) {\n    if (ev.key) {\n      FPSControls.keysDown[ev.key] = true\n    }\n  }\n\n  onKeyUp(ev: KeyboardEvent) {\n    if (ev.key) {\n      delete FPSControls.keysDown[ev.key]\n    }\n  }\n\n  keyPressed(key: string): boolean {\n    return FPSControls.keysDown[key]\n  }\n\n  get pointerLocked(): boolean {\n    return this._pointerLocked\n  }\n\n  exitPointerlock() {\n    document.exitPointerLock()\n  }\n\n  private initPointerLock() {\n    // @ts-ignore\n    this._canvas.requestPointerLock = this._canvas.requestPointerLock || this._canvas.mozRequestPointerLock\n    // @ts-ignore\n    document.exitPointerLock = document.exitPointerLock || document.mozExitPointerLock\n\n    if ('onpointerlockchange' in document) {\n      document.addEventListener('pointerlockchange', this.lockChangeAlert.bind(this), false)\n    } else if ('onmozpointerlockchange' in document) {\n      // @ts-ignore\n      document.addEventListener('mozpointerlockchange', this.lockChangeAlert.bind(this), false)\n    }\n\n    this._canvas.onclick = () => {\n      this._canvas.requestPointerLock()\n    }\n  }\n\n  lockChangeAlert() {\n    // @ts-ignore\n    this._pointerLocked = !!document.pointerLockElement || !!document.mozPointerLockElement\n    const callback = (ev: MouseEvent) => {\n      this._mouseMovementX = ev.movementX\n      this._mouseMovementY = ev.movementY\n    }\n    if (this._pointerLocked) {\n      document.addEventListener('mousemove', callback.bind(this), true)\n    } else {\n      document.removeEventListener('mousemove', callback.bind(this), true)\n      this._mouseMovementX = this._mouseMovementY = 0\n    }\n  }\n\n  pointerMovement(): vec2 {\n    if (!this._pointerLocked) {\n      return [0, 0]\n    }\n    const pos = vec2.fromValues(this._mouseMovementX, this._mouseMovementY)\n    this._mouseMovementX = damp(this._mouseMovementX)\n    this._mouseMovementY = damp(this._mouseMovementY)\n    return pos\n  }\n}\n\nconst damp = (x: number) => {\n  const xd = x * 0.9\n  if (Math.abs(xd) < 0.1) {\n    return 0\n  }\n  return xd\n}\n"],
  "mappings": "AAAA;AACA;AADA;AAAA;AAAA,iCAYiC;AAAA,EAO/B,YAAY;AACV;AANM,0BAA0B;AAE1B,2BAA0B;AAC1B,2BAA0B;AAIhC,WAAO,iBAAiB,WAAW,KAAK,WAAW;AACnD,WAAO,iBAAiB,SAAS,KAAK,SAAS;AAC/C,SAAK,UAAU;AACf,SAAK;AACL,gBAAY;AACV,UAAI,KAAK,iBAAiB,UAAU;AAClC,aAAK;AAAA;AAAA;AAAA;AAAA,EAKX;AACE,QAAI,GAAG;AACL,kBAAY,SAAS,GAAG,OAAO;AAAA;AAAA;AAAA,EAInC;AACE,QAAI,GAAG;AACL,aAAO,YAAY,SAAS,GAAG;AAAA;AAAA;AAAA,EAInC;AACE,WAAO,YAAY,SAAS;AAAA;AAAA,MAG1B;AACF,WAAO,KAAK;AAAA;AAAA,EAGd;AACE,aAAS;AAAA;AAAA,EAGH;AAEN,SAAK,QAAQ,qBAAqB,KAAK,QAAQ,sBAAsB,KAAK,QAAQ;AAElF,aAAS,kBAAkB,SAAS,mBAAmB,SAAS;AAEhE,QAAI,yBAAyB;AAC3B,eAAS,iBAAiB,qBAAqB,KAAK,gBAAgB,KAAK,OAAO;AAAA,eACvE,4BAA4B;AAErC,eAAS,iBAAiB,wBAAwB,KAAK,gBAAgB,KAAK,OAAO;AAAA;AAGrF,SAAK,QAAQ,UAAU;AACrB,WAAK,QAAQ;AAAA;AAAA;AAAA,EAIjB;AAEE,SAAK,iBAAiB,CAAC,CAAC,SAAS,sBAAsB,CAAC,CAAC,SAAS;AAClE,qBAAiB;AACf,WAAK,kBAAkB,GAAG;AAC1B,WAAK,kBAAkB,GAAG;AAAA;AAE5B,QAAI,KAAK;AACP,eAAS,iBAAiB,aAAa,SAAS,KAAK,OAAO;AAAA;AAE5D,eAAS,oBAAoB,aAAa,SAAS,KAAK,OAAO;AAC/D,WAAK,kBAAkB,KAAK,kBAAkB;AAAA;AAAA;AAAA,EAIlD;AACE,QAAI,CAAC,KAAK;AACR,aAAO,CAAC,GAAG;AAAA;AAEb,gBAAY,KAAK,WAAW,KAAK,iBAAiB,KAAK;AACvD,SAAK,kBAAkB,KAAK,KAAK;AACjC,SAAK,kBAAkB,KAAK,KAAK;AACjC,WAAO;AAAA;AAAA;AAnFM,AAbjB,YAaiB,WAAoC;AAuFrD,aAAa;AACX,aAAW,IAAI;AACf,MAAI,KAAK,IAAI,MAAM;AACjB,WAAO;AAAA;AAET,SAAO;AAAA;",
  "names": []
}
