{
  "version": 3,
  "sources": ["/Users/stojg/Sites/canola/src/index.ts"],
  "sourcesContent": ["import REGL from 'regl'\nimport resl from 'resl'\nimport { createCamera } from './lib/camera'\nimport bunny from 'bunny'\nimport plane from './models/plane'\nimport normals from 'angle-normals'\nimport { glMatrix, mat4, vec3, vec4 } from 'gl-matrix'\nimport { FPSControls } from './lib/controls'\nimport { cube } from './models/cube'\nimport createStatsWidget from 'regl-stats-widget'\nimport { Model, ModelUniforms } from './lib/model'\nimport { Lights } from './lib/lights'\nimport { debugLogger } from './lib/shame'\nimport { halfFloatTextureExt, queryTimerExt, textureFloatExt } from './lib/cap'\n\ndebugLogger()\n\nconst loading = {\n  manifest: {\n    // Each entry in the manifest represents an asset to be loaded\n    'main.fsh': { type: 'text', src: 'shaders/main.fsh' },\n    'main.vsh': { type: 'text', src: 'shaders/main.vsh' },\n    'emissive.fsh': { type: 'text', src: 'shaders/emissive.fsh' },\n    'pbr.fsh': { type: 'text', src: 'shaders/pbr.fsh' },\n    'pbr_shadow.fsh': { type: 'text', src: 'shaders/pbr_shadow.fsh' },\n    'light_cube.fsh': { type: 'text', src: 'shaders/light_cube.fsh' },\n  },\n  onProgress: (progress: number, message: any) => {},\n  onError: (err: Error) => {\n    console.debug(err)\n    console.error(err)\n  },\n  onDone: (assets: Record<string, string>) => {\n    main(assets)\n  },\n}\n\ninterface MeshAttributes {\n  position: vec3[]\n  normal: vec3[]\n}\n\nconst main = (assets: Record<string, string>) => {\n  const regl = init()\n\n  const controls = new FPSControls(regl._gl.canvas as HTMLCanvasElement)\n  const camera = createCamera(regl, controls, { position: [0, 3, 10] })\n\n  const lights = new Lights()\n  lights.add(true, [10, 10, 10], [-3, 3, -3, 1])\n  lights.add(true, [10, 0, 0], [3, 3, 3, 1])\n  lights.add(false, [0, 10, 0], [-3, 3, 3, 1])\n  lights.add(false, [0, 0, 10], [3, 3, -3, 1])\n\n  const lightProps: any = []\n  lights.all().forEach((light, i) => {\n    if (!light.on) return\n    const mtrl = { albedo: light.color, metallic: 0, roughness: 0.025, ao: 1.0 }\n    lightProps.push(new Model(mtrl, xyz(light.pos), 0.05))\n  })\n\n  function lightCubeDraw(lightId: number): REGL.DrawConfig {\n    const shadowFbo = lights.shadowFBO(regl, lightId)\n    return {\n      frag: assets['light_cube.fsh'],\n      vert: assets['main.vsh'],\n      cull: { enable: true, face: 'back' },\n      uniforms: {\n        projection: mat4.perspective(mat4.create(), glMatrix.toRadian(90), 1, 0.25, 30.0),\n        view: function (context: REGL.DefaultContext, props: any, batchId: number) {\n          switch (batchId) {\n            case 0: // +x right\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(1, 0, 0), xyz(lights.get(lightId).pos)), [0, -1, 0])\n            case 1: // -x left\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(-1, 0, 0), xyz(lights.get(lightId).pos)), [0, -1, 0])\n            case 2: // +y top\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, 1, 0), xyz(lights.get(lightId).pos)), [0, 0, 1])\n            case 3: // -y bottom\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, -1, 0), xyz(lights.get(lightId).pos)), [0, 0, -1])\n            case 4: // +z near\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, 0, 1), xyz(lights.get(lightId).pos)), [0, -1, 0])\n            case 5: // -z far\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, 0, -1), xyz(lights.get(lightId).pos)), [0, -1, 0])\n          }\n        },\n      },\n      framebuffer: function (context, props, batchId) {\n        return shadowFbo.faces[batchId]\n      },\n    }\n  }\n\n  // render point-light shadows into a cubemap\n  const drawDepth = [regl(lightCubeDraw(0)), regl(lightCubeDraw(1)), regl(lightCubeDraw(2)), regl(lightCubeDraw(3))]\n  const oneLightScope = [regl(lights.lightUniform(regl, 0)), regl(lights.lightUniform(regl, 1)), regl(lights.lightUniform(regl, 2)), regl(lights.lightUniform(regl, 3))]\n\n  const shadowDraw = regl({\n    frag: assets['pbr_shadow.fsh'],\n    vert: assets['main.vsh'],\n    cull: { enable: true, face: 'back' },\n    uniforms: {\n      'shadowCubes[0]': lights.shadowFBO(regl, 0),\n      'shadowCubes[1]': lights.shadowFBO(regl, 1),\n      'shadowCubes[2]': lights.shadowFBO(regl, 2),\n      'shadowCubes[3]': lights.shadowFBO(regl, 3),\n    },\n  })\n\n  const scale = 0.2\n  const bunnyProps = [\n    new Model({ albedo: [0.55, 0.55, 0.6], metallic: 0.25, roughness: 0.82, ao: 0.05 }, [0, 0, 0], scale, 45),\n    new Model({ albedo: [0.69, 0.27, 0.2], metallic: 0.2, roughness: 0.75, ao: 0.05 }, [4, 0, 4], scale, -45),\n    new Model({ albedo: [0.0, 0.5, 0.0], metallic: 0.0, roughness: 0.025, ao: 0.05 }, [-4, 0, 4], scale, 90),\n    new Model({ albedo: [0.0, 0.5, 0.9], metallic: 5, roughness: 0.025, ao: 0.05 }, [-2, 0, 4], scale, 35),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [-6, 0, -6], scale, 70),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [4, 0, -6], scale, 35),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [6, 0, -5], scale, -43),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [1, 0, -4], scale, -70),\n  ]\n\n  const bunnyDraw = regl<ModelUniforms, MeshAttributes>({\n    elements: bunny.cells,\n    attributes: { position: bunny.positions, normal: normals(bunny.cells, bunny.positions) },\n    uniforms: Model.uniforms(regl),\n  })\n\n  const planeProps = [\n    new Model(\n      {\n        albedo: [0.42, 0.4, 0.38],\n        metallic: 0.0,\n        roughness: 1.0,\n        ao: 0.05,\n      },\n      [0, 0, 0],\n      20,\n      90,\n      [1, 0, 0],\n    ),\n  ]\n\n  const planeDraw = regl<ModelUniforms, MeshAttributes>({\n    elements: plane.indices,\n    attributes: { position: plane.positions, normal: plane.normals },\n    uniforms: Model.uniforms(regl),\n  })\n\n  const lightBulbDraw = regl<ModelUniforms, MeshAttributes>({\n    elements: cube.indices,\n    attributes: { position: cube.positions, normal: cube.normals },\n    uniforms: Model.uniforms(regl),\n  })\n\n  const allLightScope = regl(lights.allUniforms(regl))\n\n  const plainDraw = regl({\n    frag: assets['main.fsh'],\n    vert: assets['main.vsh'],\n    cull: { enable: true, face: 'back' },\n  })\n\n  const emissiveDraw = regl({\n    frag: assets['emissive.fsh'],\n    vert: assets['main.vsh'],\n    cull: { enable: true, face: 'back' },\n  })\n\n  let statsWidget = { update: (dt: number) => {} }\n  if (queryTimerExt()) {\n    statsWidget = createStatsWidget([\n      [drawDepth[0], 'drawDepth0'],\n      [drawDepth[1], 'drawDepth1'],\n      [drawDepth[2], 'drawDepth2'],\n      [drawDepth[3], 'drawDepth3'],\n      [planeDraw, 'plane'],\n      [bunnyDraw, 'bunnies'],\n      [lightBulbDraw, 'lights'],\n    ])\n  }\n\n  regl.frame(({ tick }) => {\n    const deltaTime = 0.01666666\n    statsWidget.update(deltaTime)\n\n    for (let i = 0; i < 4; i++) {\n      if (!lights.get(i).on) {\n        continue\n      }\n      oneLightScope[i](() => {\n        drawDepth[i](6, () => {\n          regl.clear({ depth: 1, color: [1, 1, 1, 1] })\n          bunnyDraw(bunnyProps)\n          planeDraw(planeProps)\n        })\n      })\n    }\n\n    regl.clear({ color: [0.05, 0.05, 0.05, 1] })\n    camera(() => {\n      allLightScope(() => {\n        shadowDraw(() => {\n          bunnyDraw(bunnyProps)\n          planeDraw(planeProps)\n        })\n      })\n      //\n      emissiveDraw(() => {\n        lightBulbDraw(lightProps)\n      })\n    })\n  })\n}\n\nconst xyz = (t: vec4) => vec3.fromValues(t[0], t[1], t[2])\n\nconst init = function (): REGL.Regl {\n  const requestExtensions: string[] = []\n  if (queryTimerExt()) {\n    requestExtensions.push('EXT_disjoint_timer_query')\n  }\n  if (halfFloatTextureExt()) {\n    requestExtensions.push(halfFloatTextureExt())\n  }\n  if (textureFloatExt()) {\n    requestExtensions.push(textureFloatExt())\n  }\n  return REGL({\n    extensions: requestExtensions,\n    profile: true,\n    attributes: { antialias: true },\n  })\n}\n\nresl(loading)\n"],
  "mappings": "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",
  "names": []
}
