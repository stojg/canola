{
  "version": 3,
  "sources": ["/Users/stojg/Sites/canola/src/index.ts"],
  "sourcesContent": ["import REGL from 'regl'\nimport resl from 'resl'\nimport { createCamera } from './lib/camera'\nimport bunny from 'bunny'\nimport plane from './models/plane'\nimport normals from 'angle-normals'\nimport { glMatrix, mat4, vec3, vec4 } from 'gl-matrix'\nimport { FPSControls } from './lib/controls'\nimport { cube } from './models/cube'\nimport createStatsWidget from 'regl-stats-widget'\nimport { Model, ModelUniforms } from './lib/model'\nimport { Lights } from './lib/lights'\n\ninterface Assets extends Record<string, string> {}\n\nconst xyz = (t: vec4) => vec3.fromValues(t[0], t[1], t[2])\n\nconst loading = {\n  manifest: {\n    // Each entry in the manifest represents an asset to be loaded\n    'main.fsh': { type: 'text', src: 'shaders/main.fsh' },\n    'main.vsh': { type: 'text', src: 'shaders/main.vsh' },\n    'pbr.fsh': { type: 'text', src: 'shaders/pbr.fsh' },\n    'pbr_shadow.fsh': { type: 'text', src: 'shaders/pbr_shadow.fsh' },\n    'light_cube.fsh': { type: 'text', src: 'shaders/light_cube.fsh' },\n  },\n  onProgress: (progress: any, message: any) => {\n    console.log(progress, message)\n  },\n  onError: (err: Error) => {\n    console.error(err)\n  },\n  onDone: (assets: Assets) => {\n    main(assets)\n  },\n}\n\ninterface MeshAttributes {\n  position: vec3[]\n  normal: vec3[]\n}\n\nresl(loading)\n\nconst main = (assets: Assets) => {\n  const regl = REGL({\n    extensions: ['oes_texture_float', 'ext_disjoint_timer_query'],\n    profile: true,\n    attributes: { antialias: true },\n  })\n\n  const controls = new FPSControls(regl._gl.canvas as HTMLCanvasElement)\n  const camera = createCamera(regl, controls, { position: [0, 3, 10] })\n\n  const lights = new Lights()\n  lights.add(true, [10, 10, 10], [0, 3, 0, 1])\n  lights.add(true, [100, 0, 0], [3, 3, 3, 1])\n  lights.add(true, [0, 100, 0], [-3, 3, 3, 1])\n  lights.add(true, [0, 0, 100], [3, 3, -3, 1])\n\n  const lightProps: any = []\n  lights.all().forEach((light, i) => {\n    if (!light.on) return\n    const mtrl = { albedo: light.color, metallic: 0, roughness: 0.025, ao: 1.0 }\n    lightProps.push(new Model(mtrl, xyz(light.pos), 0.05))\n  })\n\n  function lightCubeDraw(lightId: number): REGL.DrawConfig {\n    const shadowFbo = lights.shadowFBO(regl, lightId)\n    return {\n      uniforms: {\n        projection: mat4.perspective(mat4.create(), glMatrix.toRadian(90), 1, 0.25, 30.0),\n        view: function (context: REGL.DefaultContext, props: any, batchId: number) {\n          switch (batchId) {\n            case 0: // +x right\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(1, 0, 0), xyz(lights.get(lightId).pos)), [0, -1, 0])\n            case 1: // -x left\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(-1, 0, 0), xyz(lights.get(lightId).pos)), [0, -1, 0])\n            case 2: // +y top\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, 1, 0), xyz(lights.get(lightId).pos)), [0, 0, 1])\n            case 3: // -y bottom\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, -1, 0), xyz(lights.get(lightId).pos)), [0, 0, -1])\n            case 4: // +z near\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, 0, 1), xyz(lights.get(lightId).pos)), [0, -1, 0])\n            case 5: // -z far\n              return mat4.lookAt(mat4.create(), xyz(lights.get(lightId).pos), vec3.add(vec3.create(), vec3.fromValues(0, 0, -1), xyz(lights.get(lightId).pos)), [0, -1, 0])\n          }\n        },\n      },\n      frag: assets['light_cube.fsh'],\n      vert: assets['main.vsh'],\n      framebuffer: function (context, props, batchId) {\n        return shadowFbo.faces[batchId]\n      },\n    }\n  }\n\n  // render point-light shadows into a cubemap\n  const drawDepth = [regl(lightCubeDraw(0)), regl(lightCubeDraw(1)), regl(lightCubeDraw(2)), regl(lightCubeDraw(3))]\n  const oneLightScope = [regl(lights.lightUniform(regl, 0)), regl(lights.lightUniform(regl, 1)), regl(lights.lightUniform(regl, 2)), regl(lights.lightUniform(regl, 3))]\n\n  const shadowDraw = regl({\n    frag: assets['pbr_shadow.fsh'],\n    vert: assets['main.vsh'],\n    cull: { enable: true, face: 'back' },\n    uniforms: {\n      'shadowCube[0]': lights.shadowFBO(regl, 0),\n      'shadowCube[1]': lights.shadowFBO(regl, 1),\n      'shadowCube[2]': lights.shadowFBO(regl, 2),\n      'shadowCube[3]': lights.shadowFBO(regl, 3),\n    },\n  })\n\n  const bunnyProps = [\n    new Model({ albedo: [0.55, 0.55, 0.6], metallic: 0.25, roughness: 0.82, ao: 0.05 }, [0, 0, 0], 0.2, 45),\n    new Model({ albedo: [0.69, 0.27, 0.2], metallic: 0.2, roughness: 0.75, ao: 0.05 }, [4, 0, 4], 0.2, -45),\n    new Model({ albedo: [0.0, 0.5, 0.0], metallic: 0.0, roughness: 0.025, ao: 0.05 }, [-4, 0, 4], 0.2, 90),\n    new Model({ albedo: [0.0, 0.5, 0.9], metallic: 5, roughness: 0.025, ao: 0.05 }, [-2, 0, 4], 0.2, 35),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [-6, 0, -6], 0.2, 70),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [4, 0, -6], 0.2, 35),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [6, 0, -5], 0.2, -43),\n    new Model({ albedo: [0.5, 0.5, 0.5], metallic: 5, roughness: 0.025, ao: 0.05 }, [1, 0, -4], 0.2, -70),\n  ]\n\n  const planeProps = [\n    new Model(\n      {\n        albedo: [0.42, 0.4, 0.38],\n        metallic: 0.69,\n        roughness: 0.08,\n        ao: 0.0,\n      },\n      [0, 0, 0],\n      20,\n      90,\n      [1, 0, 0],\n    ),\n  ]\n\n  const bunnyDraw = regl<ModelUniforms, MeshAttributes>({\n    elements: bunny.cells,\n    attributes: { position: bunny.positions, normal: normals(bunny.cells, bunny.positions) },\n    uniforms: Model.uniforms(regl),\n  })\n\n  const planeDraw = regl<ModelUniforms, MeshAttributes>({\n    elements: plane.indices,\n    attributes: { position: plane.positions, normal: plane.normals },\n    uniforms: Model.uniforms(regl),\n  })\n\n  const lightBulbDraw = regl<ModelUniforms, MeshAttributes>({\n    elements: cube.indices,\n    attributes: { position: cube.positions, normal: cube.normals },\n    uniforms: Model.uniforms(regl),\n  })\n\n  const allLightScope = regl(lights.allUniforms(regl))\n\n  const plainDraw = regl({\n    frag: assets['main.fsh'],\n    vert: assets['main.vsh'],\n    cull: { enable: true, face: 'back' },\n  })\n\n  const statsWidget = createStatsWidget([\n    [planeDraw, 'plane'],\n    [bunnyDraw, 'bunnies'],\n    [lightBulbDraw, 'lights'],\n  ])\n\n  regl.frame(({ tick }) => {\n    const deltaTime = 0.017\n    statsWidget.update(deltaTime)\n\n    for (let i = 0; i < 4; i++) {\n      oneLightScope[i](() => {\n        drawDepth[i](6, () => {\n          regl.clear({ depth: 1 })\n          bunnyDraw(bunnyProps)\n          planeDraw(planeProps)\n        })\n      })\n    }\n\n    regl.clear({ color: [0.05, 0.05, 0.05, 1] })\n    camera(() => {\n      allLightScope(() => {\n        shadowDraw(() => {\n          bunnyDraw(bunnyProps)\n          planeDraw(planeProps)\n        })\n      })\n\n      plainDraw(() => {\n        lightBulbDraw(lightProps)\n      })\n    })\n  })\n}\n"],
  "mappings": "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",
  "names": []
}
